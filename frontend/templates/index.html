<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A-SHARE.TOP    一个A股观察站</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="/static/js/articles-data.js?v=1.0.2"></script>
    <script src="/static/js/articles-utils.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --pencil-gray: #6c6c6c;
            --paper-white: #fefefe;
            --accent-blue: #4a90e2;
            --accent-green: #7ed321;
            --sketch-line: #d3d3d3;
            --blue-green: #2cbfc7;
            --light-yellow: #fffacd;
            --blue-black: #2c3e50;
        }

        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Comic Neue', cursive, sans-serif;
            background-color: var(--paper-white);
            color: var(--pencil-gray);
            overflow-x: hidden;
            position: relative;
        }

        .header-section {
            padding: 20px 0;
            text-align: left;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: var(--light-yellow);
            background-image: linear-gradient(to right, transparent 0%, var(--sketch-line) 50%, transparent 100%);
            background-size: 200% 1px;
            background-repeat: no-repeat;
            background-position: center bottom;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header-title {
            font-size: 2.2rem;
            color: var(--blue-black);
            display: inline-block;
            position: relative;
            font-weight: normal;
            letter-spacing: 1px;
            margin-left: 30px;
            font-family: 'Calibri', sans-serif;
        }

            .header-title::after {
                content: '';
                position: absolute;
                bottom: -8px;
                left: 0;
                width: 100%;
                height: 15px;
                background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 20'%3E%3Cpath d='M0,10 Q30,0 60,10 T120,10' stroke='%232c3e50' stroke-width='2' fill='none' stroke-dasharray='5,5'/%3E%3C/svg%3E") no-repeat center;
                background-size: contain;
            }

        /* 修改侧边栏样式，使其固定定位 - 桌面端 */
        .sidebar {
            width: 200px;
            padding: 30px 0;
            position: fixed;
            top: 100px;
            left: 0;
            height: calc(100vh - 100px);
            overflow-y: auto;
            z-index: 999;
            background-color: var(--paper-white);
        }

            .sidebar::before {
                content: '';
                position: absolute;
                right: 0;
                top: 10%;
                height: 80%;
                width: 1px;
                background: linear-gradient(to bottom, transparent, var(--sketch-line), transparent);
            }

        /* 调整主容器，为固定侧边栏留出空间 - 桌面端 */
        .main-container {
            display: flex;
            min-height: calc(100vh - 100px);
            margin-top: 100px;
            margin-left: 200px;
        }

        .nav-item {
            padding: 15px 25px;
            color: var(--pencil-gray);
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            position: relative;
            font-size: 1.1rem;
            margin: 5px 0;
            cursor: pointer;
        }

            .nav-item::before {
                content: '';
                position: absolute;
                left: 10px;
                top: 50%;
                transform: translateY(-50%);
                width: 8px;
                height: 8px;
                background: var(--accent-blue);
                border-radius: 50%;
                opacity: 0;
                transition: opacity 0.3s;
            }

            .nav-item:hover::before,
            .nav-item.active::before {
                opacity: 1;
            }

            .nav-item:hover {
                color: var(--accent-blue);
                transform: translateX(5px);
            }

            .nav-item.active {
                color: var(--accent-blue);
                font-weight: bold;
            }

            .nav-item i {
                margin-right: 10px;
                font-size: 1.2rem;
            }

        .content-area {
            flex: 1;
            padding: 40px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .control-panel {
            width: 100%;
            max-width: 600px;
            padding: 40px 20px;
            position: relative;
            background: transparent;
            border: none;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .form-group {
            margin-bottom: 40px;
            position: relative;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .form-control {
            background: transparent;
            border: none;
            border-bottom: 2px solid var(--sketch-line);
            border-radius: 0;
            color: var(--pencil-gray);
            padding: 10px 0;
            font-size: 1.1rem;
            width: 100%;
            transition: all 0.3s ease;
            font-family: inherit;
            text-align: center;
        }

            .form-control:focus {
                outline: none;
                border-bottom-color: var(--accent-blue);
                box-shadow: 0 2px 0 -1px var(--accent-blue);
            }

        .btn-custom {
            background: transparent;
            border: 2px dashed var(--accent-blue);
            color: var(--accent-blue);
            padding: 12px 30px;
            border-radius: 50px 10px 50px 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: auto;
            margin: 30px 0;
            font-family: inherit;
            font-weight: normal;
            display: inline-block;
            text-align: center;
        }

            .btn-custom:hover {
                background: rgba(74, 144, 226, 0.1);
                border-style: solid;
                transform: rotate(-1deg) scale(1.02);
                box-shadow: 0 5px 15px rgba(74, 144, 226, 0.2);
            }

            .btn-custom:active {
                transform: rotate(1deg) scale(0.98);
            }

        .link-group {
            display: flex;
            justify-content: center;
            margin-top: 40px;
            gap: 60px;
        }

        .link-custom {
            color: var(--pencil-gray);
            text-decoration: none;
            padding: 8px 15px;
            border: 1px dashed var(--sketch-line);
            border-radius: 20px 5px 20px 5px;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            position: relative;
            background: rgba(255, 255, 255, 0.5);
            white-space: nowrap;
        }

            .link-custom:hover {
                color: var(--accent-green);
                border-color: var(--accent-green);
                border-style: solid;
                transform: rotate(-1deg);
            }

            .link-custom i {
                margin-right: 5px;
            }

        .content-panel {
            width: 100%;
            display: none;
            text-align: center;
        }

            .content-panel.active {
                display: flex;
                justify-content: center;
            }

        .panel-title {
            font-size: 1.8rem;
            color: var(--blue-black);
            margin-bottom: 30px;
            font-family: 'Calibri', sans-serif;
        }

        .panel-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            text-align: left;
        }

        .about-content p {
            margin-bottom: 15px;
            text-indent: 0;
        }

        .about-content ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .about-content li {
            margin-bottom: 8px;
        }

        .modal-content {
            border-radius: 15px;
            border: 2px solid var(--sketch-line);
        }

        .modal-header {
            border-bottom: 1px dashed var(--sketch-line);
            background-color: var(--light-yellow);
        }

        .modal-title {
            color: var(--pencil-gray);
            font-weight: normal;
        }

        .chart-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 0 auto;
        }

        .nav-btn {
            background: transparent;
            border: 2px solid var(--accent-blue);
            color: var(--accent-blue);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

            .nav-btn:hover {
                background: var(--accent-blue);
                color: white;
                transform: scale(1.1);
            }

            .nav-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
            }

                .nav-btn:disabled:hover {
                    background: transparent;
                    color: var(--accent-blue);
                }

        .chart-counter {
            font-size: 1.1rem;
            color: var(--pencil-gray);
            min-width: 80px;
            text-align: center;
        }

        .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            padding: 1rem;
            border-top: 1px dashed var(--sketch-line);
        }

        .footer-left {
            display: flex;
            align-items: center;
            order: 1;
        }

        .footer-center {
            flex: 1;
            display: flex;
            justify-content: center;
            order: 2;
        }

        .footer-right {
            display: flex;
            align-items: center;
            order: 3;
        }

        .btn-download {
            background-color: var(--light-yellow);
            color: var(--pencil-gray);
            border: 2px dashed var(--pencil-gray);
            border-radius: 50px 10px 50px 10px;
            padding: 8px 20px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            font-weight: normal;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

            .btn-download:hover {
                background: rgba(255, 250, 205, 0.8);
                border-style: solid;
                transform: rotate(-1deg) scale(1.02);
                box-shadow: 0 5px 15px rgba(108, 108, 108, 0.2);
            }

            .btn-download:active {
                transform: rotate(1deg) scale(0.98);
            }

        .modal-xl {
            max-width: 900px;
        }

        .modal-body {
            padding: 1rem;
            max-height: 500px;
            overflow-y: auto;
        }

        #chartContainer {
            width: 100%;
            height: 400px;
        }

        .modal-title {
            font-size: 1.1rem;
        }

        .modal-header {
            padding: 0.75rem 1rem;
        }

        .modal-footer {
            padding: 0.75rem 1rem;
        }

        .nav-btn {
            width: 35px;
            height: 35px;
            font-size: 1rem;
        }

        .chart-counter {
            font-size: 1rem;
            min-width: 70px;
        }

        .btn-download {
            padding: 6px 15px;
            font-size: 0.9rem;
        }

        .articles-container {
            margin-top: 30px;
        }

        .article-item {
            border: none;
            border-radius: 0;
            padding: 4px 0;
            margin-bottom: 20px;
            background: transparent;
            transition: all 0.3s ease;
        }

        .article-item:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.7);
        }

        .article-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0px;
        }

        .article-title {
            color: var(--blue-black);
            font-size: 1.3rem;
            margin: 0;
            flex: 1;
            line-height: 2;
            cursor: pointer;
            text-decoration: none;
        }

        .article-title-link {
            color: var(--blue-black);
            font-size: 1rem;
            line-height: 1.0;
            cursor: pointer;
            text-decoration: underline;
            display: inline-flex;
            margin-bottom: 5px;
        }

        .article-date-link {
            color: var(--blue-black);
            font-size: 1rem;
            line-height: 1.2;
            cursor: pointer;
            text-decoration: underline;
            margin-left: 15px;
            white-space: nowrap;
        }

        .article-meta {
            color: var(--pencil-gray);
            font-size: 0.9rem;
            white-space: nowrap;
            margin-left: 15px;
        }

        .article-description {
            color: var(--pencil-gray);
            line-height: 1.6;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .article-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .keyword-tag {
            display: inline-block;
            background: var(--light-yellow);
            color: var(--pencil-gray);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-right: 5px;
            border: 1px dashed var(--sketch-line);
        }

        .btn-read-article {
            background: transparent;
            border: 2px dashed var(--accent-green);
            color: var(--accent-green);
            padding: 6px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .btn-read-article:hover {
            background: rgba(126, 211, 33, 0.1);
            border-style: solid;
        }

        .article-controls {
            display: flex;
            gap: 15px;
            margin: 10px 0 20px 0;
            flex-wrap: wrap;
        }

        .search-box {
            position: relative;
            flex: 1;
            min-width: 200px;
        }

        .search-box .fa-search {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--pencil-gray);
        }

        .filter-options {
            min-width: 150px;
        }

        .article-meta-info {
            background: var(--light-yellow);
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .article-meta-info span {
            color: var(--pencil-gray);
            font-size: 0.9rem;
        }

        .article-content {
            line-height: 1.8;
            color: var(--pencil-gray);
            margin-bottom: 20px;
        }

        .related-articles {
            border-top: 1px dashed var(--sketch-line);
            padding-top: 15px;
        }

        .related-articles h6 {
            color: var(--blue-black);
            margin-bottom: 10px;
        }

        .related-link {
            display: block;
            color: var(--accent-blue);
            text-decoration: none;
            padding: 5px 0;
            border-bottom: 1px dashed transparent;
            transition: all 0.3s ease;
        }

        .related-link:hover {
            color: var(--accent-green);
            border-bottom-color: var(--accent-green);
        }

        .no-articles {
            text-align: center;
            color: var(--pencil-gray);
            font-style: italic;
            padding: 40px 0;
        }

        #knowledge-research-panel .control-panel {
            padding-top: 20px;
        }

        #knowledge-research-panel .panel-content {
            padding-top: 10px;
        }

        .article-header > div {
            display: flex;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .article-title-link {
            flex: 1;
        }

        .article-date-link {
            flex-shrink: 0;
            margin-left: 15px;
        }

        /* 移动端底部固定导航栏 */
        .mobile-bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--light-yellow);
            border-top: 2px dashed var(--sketch-line);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: none; /* 默认隐藏，在移动端显示 */
        }

        /* 底部导航项 */
        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--pencil-gray);
            padding: 8px 12px;
            border-radius: 15px;
            transition: all 0.3s ease;
            flex: 1;
            max-width: 80px;
        }

        .mobile-nav-item.active {
            color: var(--accent-blue);
            background: rgba(74, 144, 226, 0.1);
        }

        .mobile-nav-item i {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        .mobile-nav-item span {
            font-size: 0.7rem;
            text-align: center;
            line-height: 1.1;
        }

        @media (max-width: 768px) {
            /* 隐藏桌面端侧边栏 */
            .sidebar {
                display: none;
            }

            /* 调整主容器 */
            .main-container {
                flex-direction: column;
                margin-top: 80px;
                margin-left: 0;
                margin-bottom: 70px; /* 为底部导航留出空间 */
            }

            .header-title {
                font-size: 1.8rem;
                margin-left: 15px;
            }

            .header-section {
                padding: 15px 0;
            }

            .control-panel {
                padding: 30px 15px;
            }

            .link-group {
                flex-direction: column;
                gap: 20px;
                align-items: center;
            }

            .modal-footer {
                flex-direction: column;
                gap: 15px;
            }

            .footer-left, .footer-center, .footer-right {
                width: 100%;
                justify-content: center;
                order: unset;
            }

            .chart-nav {
                margin: 10px 0;
            }

            .modal-xl {
                max-width: 95%;
                margin: 1rem auto;
            }

            .modal-body {
                max-height: 400px;
            }

            #chartContainer {
                height: 300px;
                position: relative;
            }

            #chartCanvas {
                width: 100% !important;
                height: 100% !important;
            }

            .mobile-chart-points {
                pointRadius: 2 !important;
                pointHoverRadius: 3 !important;
            }

            .mobile-footer-buttons {
                display: flex;
                justify-content: center;
                gap: 15px;
                width: 100%;
                margin-top: 10px;
            }

                .mobile-footer-buttons .btn-download {
                    flex: 1;
                    max-width: 140px;
                }

            .article-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .article-title-link, .article-date-link {
                font-size: 1rem;
                line-height: 1.2;
            }

            .article-date-link {
                margin-left: 0;
                margin-top: 5px;
            }

            #knowledge-research-panel .control-panel {
                padding-top: 15px;
            }

            .article-header > div {
                flex-direction: column;
                align-items: flex-start;
            }

            /* 显示移动端底部导航 */
            .mobile-bottom-nav {
                display: flex;
            }

            /* 内容区域在移动端的额外内边距 */
            .content-area {
                padding-bottom: 20px;
            }
        }

        /* 针对小屏幕的优化 */
        @media (max-width: 480px) {
            .mobile-nav-item {
                padding: 6px 8px;
            }

            .mobile-nav-item i {
                font-size: 1.1rem;
            }

            .mobile-nav-item span {
                font-size: 0.65rem;
            }

            .mobile-bottom-nav {
                padding: 8px 0;
            }

            .main-container {
                margin-bottom: 65px;
            }
        }

        /* 针对横屏模式的优化 */
        @media (max-width: 768px) and (orientation: landscape) {
            .mobile-bottom-nav {
                padding: 6px 0;
            }

            .mobile-nav-item {
                padding: 4px 8px;
            }

            .main-container {
                margin-bottom: 60px;
            }
        }
    </style>
    <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
    <script>LA.init({ id: "3NlvSR2kT1afN6AF", ck: "3NlvSR2kT1afN6AF" })</script>
</head>
<body>
    <div class="header-section">
        <h1 class="header-title">A-SHARE.TOP</h1>
    </div>

    <div class="main-container">
        <nav class="sidebar">
            <a class="nav-item active" data-panel="overview-panel">
                <i class="fas fa-chart-line"></i>
                个股概览
            </a>
            <a class="nav-item" data-panel="indicator-screening-panel">
                <i class="fas fa-filter"></i>
                指标筛查
            </a>
            <a class="nav-item" data-panel="knowledge-research-panel">
                <i class="fas fa-book"></i>
                知识研究
            </a>
            <a class="nav-item" data-panel="about-panel">
                <i class="fas fa-info-circle"></i>
                关于本站
            </a>
        </nav>

        <main class="content-area">
            <div class="content-panel active" id="overview-panel">
                <div class="control-panel">
                    <div class="form-group">
                        <input type="text" class="form-control" id="stockCode" placeholder="请输入股票代码，例如：000001;000002;600000">
                    </div>

                    <button class="btn-custom" id="confirmBtn">
                        确认生成图表
                    </button>

                    <div class="link-group">
                        <a href="#" class="link-custom" id="batchImportBtn">
                            <i class="fas fa-upload"></i> 批量导入
                        </a>
                        <a href="#" class="link-custom" id="templateBtn">
                            <i class="fas fa-download"></i> 模板下载
                        </a>
                    </div>
                </div>
            </div>

            <div class="content-panel" id="indicator-screening-panel">
                <div class="control-panel">
                    <h3 class="panel-title">指标筛查</h3>
                    <div class="panel-content">
                        <p>基于多种财务指标和技术指标，对A股市场进行智能筛查和分析。</p>
                        <p>功能正在开发中，敬请期待...</p>
                    </div>
                </div>
            </div>

            <div class="content-panel" id="knowledge-research-panel">
                <div class="control-panel">
                    <div class="panel-content">
                        <div class="article-controls">
                            <div class="search-box">
                                <input type="text" id="articleSearch" class="form-control" placeholder="搜索文章...">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>

                        <div id="knowledge-research-articles" class="articles-container">
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-panel" id="about-panel">
                <div class="control-panel">
                    <h3 class="panel-title">关于本站</h3>
                    <div class="panel-content about-content">
                        <p><strong>A-SHARE.TOP - 一个A股观察站</strong></p>
        
                        <p>这是一个专注于中国A股市场研究的独立平台，致力于通过数据可视化和基本面分析，帮助投资者更深入地理解上市公司价值。</p>
        
                        <p><strong>核心功能：</strong><br>
                            个股概览：企业价值分析。对企业价格及价值进行综合分析。<br>
                             指标筛查：对A股上市企业指标进行动态筛选分析。<br>
                             知识研究：投资知识研究与方法论分享。<br>
                        </p>
        
                        <p><strong>数据说明：</strong><br>
                            基于公开市场数据，定期更新，力求准确反映市场状况。</p>
        
                        <p><strong>使用指南：</strong><br>
                             个股概览：手动输入或使用批量导入代码进行股票分析。<br>
                             指标筛查：使用批量导入处理多股票分析。<br>
                             知识研究：在知识库中查阅心得与方法。支持对文章名称、简介、分类进行查找。文章分类包括：名著品介、传奇人物、投研心得。</p>
        
                        <p><strong>免责声明：</strong><br>
                            本站内容仅供参考，不构成投资建议。投资有风险，决策需谨慎。</p>
        
                        <p><strong>联系我们：</strong><br>
                             zbenhan@126.com</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 移动端底部导航栏 -->
    <div class="mobile-bottom-nav">
        <a class="mobile-nav-item active" data-panel="overview-panel">
            <i class="fas fa-chart-line"></i>
            <span>个股概览</span>
        </a>
        <a class="mobile-nav-item" data-panel="indicator-screening-panel">
            <i class="fas fa-filter"></i>
            <span>指标筛查</span>
        </a>
        <a class="mobile-nav-item" data-panel="knowledge-research-panel">
            <i class="fas fa-book"></i>
            <span>知识研究</span>
        </a>
        <a class="mobile-nav-item" data-panel="about-panel">
            <i class="fas fa-info-circle"></i>
            <span>关于本站</span>
        </a>
    </div>

    <input type="file" id="fileInput" accept=".xlsx" style="display: none;">

    <div class="modal fade" id="chartModal" tabindex="-1" aria-labelledby="chartModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chartModalLabel">股票分析图表</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="chartContainer">
                        <canvas id="chartCanvas"></canvas>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="footer-left">
                        <button type="button" class="btn-download" onclick="downloadCurrentChart()">
                            <i class="fas fa-download"></i> 下载图表
                        </button>
                    </div>
                    <div class="footer-center">
                        <div class="chart-nav">
                            <button class="nav-btn" id="prevChart" title="上一个图表 (左箭头)">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="chart-counter">
                                <span id="currentChart">1</span> / <span id="totalCharts">1</span>
                            </div>
                            <button class="nav-btn" id="nextChart" title="下一个图表 (右箭头)">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="footer-right">
                        <button type="button" class="btn-download" onclick="downloadCurrentData()">
                            <i class="fas fa-table"></i> 下载数据
                        </button>
                    </div>

                    <div class="mobile-footer-buttons" style="display: none;">
                        <button type="button" class="btn-download" onclick="downloadCurrentChart()">
                            <i class="fas fa-download"></i> 下载图表
                        </button>
                        <button type="button" class="btn-download" onclick="downloadCurrentData()">
                            <i class="fas fa-table"></i> 下载数据
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let stocksData = [];
        let currentChartIndex = 0;
        let chartModal = null;
        let originalButtonText = '';
        let currentChart = null;

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // 移动端导航功能
        function initializeMobileNavigation() {
            const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
            const desktopNavItems = document.querySelectorAll('.nav-item');
            const mobileBottomNav = document.querySelector('.mobile-bottom-nav');

            // 检测是否为移动端并显示底部导航
            function checkMobileView() {
                if (window.innerWidth <= 768) {
                    mobileBottomNav.style.display = 'flex';
                } else {
                    mobileBottomNav.style.display = 'none';
                }
            }

            // 初始检查
            checkMobileView();

            // 窗口大小改变时检查
            window.addEventListener('resize', checkMobileView);

            // 移动端导航点击事件
            mobileNavItems.forEach(item => {
                item.addEventListener('click', function() {
                    // 更新移动端导航激活状态
                    mobileNavItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');

                    // 更新桌面端导航激活状态（保持同步）
                    const panelId = this.getAttribute('data-panel');
                    desktopNavItems.forEach(nav => {
                        if (nav.getAttribute('data-panel') === panelId) {
                            nav.classList.add('active');
                        } else {
                            nav.classList.remove('active');
                        }
                    });

                    // 切换面板
                    document.querySelectorAll('.content-panel').forEach(panel => {
                        panel.classList.remove('active');
                    });
                    document.getElementById(panelId).classList.add('active');

                    // 如果是知识研究面板，初始化文章
                    if (panelId === 'knowledge-research-panel') {
                        setTimeout(() => {
                            renderArticles('knowledge-research', 'knowledge-research-articles');
                            setupArticleSearch();
                        }, 100);
                    }
                });
            });
        }

        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function () {
                document.querySelectorAll('.nav-item').forEach(nav => {
                    nav.classList.remove('active');
                });

                this.classList.add('active');

                const panelId = this.getAttribute('data-panel');

                document.querySelectorAll('.content-panel').forEach(panel => {
                    panel.classList.remove('active');
                });

                document.getElementById(panelId).classList.add('active');

                // 同步移动端导航状态
                const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
                mobileNavItems.forEach(nav => {
                    if (nav.getAttribute('data-panel') === panelId) {
                        nav.classList.add('active');
                    } else {
                        nav.classList.remove('active');
                    }
                });

                // 如果是知识研究面板，初始化文章
                if (panelId === 'knowledge-research-panel') {
                    setTimeout(() => {
                        renderArticles('knowledge-research', 'knowledge-research-articles');
                        setupArticleSearch();
                    }, 100);
                }
            });
        });

         function checkUrlParamsAndSwitchPanel() {
            const urlParams = new URLSearchParams(window.location.search);
            const panelParam = urlParams.get('panel');
    
            if (panelParam) {
                document.querySelectorAll('.nav-item').forEach(nav => {
                    nav.classList.remove('active');
                });
        
                document.querySelectorAll('.content-panel').forEach(panel => {
                    panel.classList.remove('active');
                });
        
                const targetNavItem = document.querySelector(`.nav-item[data-panel="${panelParam}-panel"]`);
                const targetPanel = document.getElementById(`${panelParam}-panel`);
        
                if (targetNavItem && targetPanel) {
                    targetNavItem.classList.add('active');
                    targetPanel.classList.add('active');
            
                    // 同步移动端导航状态
                    const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
                    mobileNavItems.forEach(nav => {
                        if (nav.getAttribute('data-panel') === `${panelParam}-panel`) {
                            nav.classList.add('active');
                        } else {
                            nav.classList.remove('active');
                        }
                    });
            
                    if (panelParam === 'knowledge-research') {
                        setTimeout(() => {
                            renderArticles('knowledge-research', 'knowledge-research-articles');
                            setupArticleSearch();
                        }, 100);
                    }
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            checkUrlParamsAndSwitchPanel();
            initializeKnowledgeResearch();
            initializeMobileNavigation(); // 初始化移动端导航
        });

        document.getElementById('confirmBtn').addEventListener('click', function () {
            const stockCode = document.getElementById('stockCode').value.trim();

            originalButtonText = this.innerHTML;

            if (!stockCode) {
                if (confirm('文本框为空，是否随机查询10支股票？')) {
                    getRandomStockCodes();
                } else {
                    restoreButtonState();
                }
                return;
            }

            const codes = stockCode.split(';').map(code => code.trim()).filter(code => code);
            for (let code of codes) {
                if (code.length !== 6 || isNaN(code)) {
                    alert(`股票代码 "${code}" 必须是6位数字`);
                    restoreButtonState();
                    return;
                }
            }

            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 获取数据中...';
            this.disabled = true;

            getStockData(stockCode);
        });

        function getRandomStockCodes() {
            const confirmBtn = document.getElementById('confirmBtn');
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 获取随机股票中...';
            confirmBtn.disabled = true;

            fetch('/api/get-random-stocks/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') || ''
                },
                body: JSON.stringify({})
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('stockCode').value = data.stock_codes;
                        getStockData(data.stock_codes);
                    } else {
                        alert('获取随机股票代码失败: ' + data.error);
                        restoreButtonState();
                    }
                })
                .catch(error => {
                    console.error('获取随机股票代码失败:', error);
                    alert('获取随机股票代码失败: ' + error.message);
                    restoreButtonState();
                });
        }

        function getStockData(stockCode) {
            fetch('/api/get-stock-data/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') || ''
                },
                body: JSON.stringify({
                    stock_number: stockCode
                })
            })
                .then(response => {
                    const contentType = response.headers.get('content-type');

                    if (!contentType || !contentType.includes('application/json')) {
                        return response.text().then(htmlContent => {
                            displayHtmlResponse(htmlContent);
                            throw new Error('服务器返回了HTML页面而不是JSON数据');
                        });
                    }

                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || `HTTP错误! 状态码: ${response.status}`);
                        });
                    }

                    return response.json();
                })
                .then(data => {
                    restoreButtonState();

                    console.log('响应数据:', data);

                    if (data.success) {
                        stocksData = data.stocks_data || [];
                        currentChartIndex = 0;

                        if (stocksData.length === 0) {
                            alert('未获取到股票数据');
                            return;
                        }

                        showChart(currentChartIndex);

                        if (!chartModal) {
                            chartModal = new bootstrap.Modal(document.getElementById('chartModal'));

                            document.getElementById('chartModal').addEventListener('hidden.bs.modal', function () {
                                document.getElementById('stockCode').value = '';
                                if (currentChart) {
                                    currentChart.destroy();
                                    currentChart = null;
                                }
                            });
                        }
                        chartModal.show();

                    } else {
                        alert('错误: ' + (data.error || data.message || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    restoreButtonState();
                    alert('请求失败，详细错误信息已在新窗口中显示');
                });
        }

        function restoreButtonState() {
            const confirmBtn = document.getElementById('confirmBtn');
            confirmBtn.innerHTML = originalButtonText;
            confirmBtn.disabled = false;
        }

        function showChart(index) {
            if (index < 0 || index >= stocksData.length) {
                return;
            }

            const stockData = stocksData[index];

            if (currentChart) {
                currentChart.destroy();
            }

            const ctx = document.getElementById('chartCanvas').getContext('2d');

            const isMobile = window.innerWidth <= 768;

            const marketCapData = stockData.market_cap_data
                .filter(item => item.market_capitalization > 0)
                .map(item => {
                    const date = new Date(item.data_date);
                    date.setFullYear(date.getFullYear() - 1);
                    return {
                        x: date,
                        y: item.market_capitalization
                    };
                });

            const profitData = stockData.profit_data
                .filter(item => item.net_profit_parent_quarterly !== null && item.net_profit_parent_quarterly !== 0)
                .map(item => {
                    const date = new Date(item.data_date);
                    date.setFullYear(date.getFullYear() - 1);
                    return {
                        x: date,
                        y: item.net_profit_parent_quarterly
                    };
                });

            const marketCapValues = marketCapData.map(item => Math.abs(item.y));
            const profitValues = profitData.map(item => Math.abs(item.y));

            const maxMarketCap = Math.max(...marketCapValues);
            const maxProfit = Math.max(...profitValues);

            let marketCapUnit = '';
            let marketCapDivisor = 1;
            if (maxMarketCap >= 100000000) {
                marketCapUnit = '亿';
                marketCapDivisor = 100000000;
            } else if (maxMarketCap >= 10000) {
                marketCapUnit = '万';
                marketCapDivisor = 10000;
            }

            let profitUnit = '';
            let profitDivisor = 1;
            if (maxProfit >= 100000000) {
                profitUnit = '亿';
                profitDivisor = 100000000;
            } else if (maxProfit >= 10000) {
                profitUnit = '万';
                profitDivisor = 10000;
            }

            function formatNumber(value, divisor) {
                const num = value / divisor;
                return num.toFixed(2).replace(/\.?0+$/, '');
            }

            const pointRadius = isMobile ? 2 : 3;
            const pointHoverRadius = isMobile ? 3 : 5;

            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: '市值',
                            data: marketCapData,
                            borderColor: 'darkblue',
                            backgroundColor: 'rgba(0, 0, 139, 0.1)',
                            yAxisID: 'y',
                            tension: 0.1,
                            pointRadius: pointRadius,
                            pointHoverRadius: pointHoverRadius,
                            borderWidth: 2
                        },
                        {
                            label: '净利润',
                            data: profitData,
                            borderColor: 'orange',
                            backgroundColor: 'rgba(255, 165, 0, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.1,
                            pointRadius: pointRadius,
                            pointHoverRadius: pointHoverRadius,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'nearest',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: `${stockData.stock_name}(${stockData.stock_code})市值与净利润趋势分析`,
                            font: {
                                size: isMobile ? 14 : 16
                            }
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'year',
                                displayFormats: {
                                    year: 'yyyy年'
                                },
                                tooltipFormat: 'yyyy年MM月'
                            },
                            title: {
                                display: true,
                                text: '日期',
                                font: {
                                    size: isMobile ? 12 : 14
                                }
                            },
                            grid: {
                                color: function (context) {
                                    if (context.tick && context.tick.major) {
                                        return 'rgba(220, 220, 220, 0.2)';
                                    }
                                    return 'rgba(150, 150, 150, 0.3)';
                                },
                                lineWidth: function (context) {
                                    if (context.tick && context.tick.major) {
                                        return 0.5;
                                    }
                                    return 1;
                                }
                            },
                            ticks: {
                                source: 'auto',
                                autoSkip: true,
                                maxTicksLimit: isMobile ? 6 : 10,
                                font: {
                                    size: isMobile ? 10 : 12
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '市值',
                                color: 'darkblue',
                                font: {
                                    weight: 'bold',
                                    size: isMobile ? 12 : 14
                                }
                            },
                            ticks: {
                                color: 'darkblue',
                                callback: function (value) {
                                    if (marketCapDivisor > 1) {
                                        return formatNumber(value, marketCapDivisor) + marketCapUnit;
                                    }
                                    return value.toLocaleString();
                                },
                                font: {
                                    size: isMobile ? 10 : 12
                                }
                            },
                            grid: {
                                color: function (context) {
                                    if (context.tick && context.tick.major) {
                                        return 'rgba(220, 220, 220, 0.2)';
                                    }
                                    return 'rgba(150, 150, 150, 0.3)';
                                },
                                lineWidth: function (context) {
                                    if (context.tick && context.tick.major) {
                                        return 0.5;
                                    }
                                    return 1;
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '净利润',
                                color: 'orange',
                                font: {
                                    weight: 'bold',
                                    size: isMobile ? 12 : 14
                                }
                            },
                            ticks: {
                                color: 'orange',
                                callback: function (value) {
                                    if (profitDivisor > 1) {
                                        return formatNumber(value, profitDivisor) + profitUnit;
                                    }
                                    return value.toLocaleString();
                                },
                                font: {
                                    size: isMobile ? 10 : 12
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });

            document.getElementById('chartModalLabel').textContent =
                `${stockData.stock_name}(${stockData.stock_code}) - 市值与净利润趋势分析`;

            document.getElementById('currentChart').textContent = index + 1;
            document.getElementById('totalCharts').textContent = stocksData.length;

            document.getElementById('prevChart').disabled = index === 0;
            document.getElementById('nextChart').disabled = index === stocksData.length - 1;

            adjustFooterLayout(isMobile);

            currentChartIndex = index;
        }

        function adjustFooterLayout(isMobile) {
            const desktopFooterLeft = document.querySelector('.footer-left');
            const desktopFooterRight = document.querySelector('.footer-right');
            const mobileFooterButtons = document.querySelector('.mobile-footer-buttons');

            if (isMobile) {
                desktopFooterLeft.style.display = 'none';
                desktopFooterRight.style.display = 'none';
                mobileFooterButtons.style.display = 'flex';
            } else {
                desktopFooterLeft.style.display = 'flex';
                desktopFooterRight.style.display = 'flex';
                mobileFooterButtons.style.display = 'none';
            }
        }

        document.getElementById('prevChart').addEventListener('click', function () {
            if (currentChartIndex > 0) {
                showChart(currentChartIndex - 1);
            }
        });

        document.getElementById('nextChart').addEventListener('click', function () {
            if (currentChartIndex < stocksData.length - 1) {
                showChart(currentChartIndex + 1);
            }
        });

        document.addEventListener('keydown', function (e) {
            const modal = document.getElementById('chartModal');
            if (modal && modal.classList.contains('show')) {
                switch (e.key) {
                    case 'ArrowLeft':
                        if (currentChartIndex > 0) {
                            showChart(currentChartIndex - 1);
                            e.preventDefault();
                        }
                        break;
                    case 'ArrowRight':
                        if (currentChartIndex < stocksData.length - 1) {
                            showChart(currentChartIndex + 1);
                            e.preventDefault();
                        }
                        break;
                    case 'Escape':
                        if (chartModal) {
                            chartModal.hide();
                        }
                        break;
                }
            }
        });

        document.getElementById('templateBtn').addEventListener('click', function (e) {
            e.preventDefault();

            const originalHtml = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 下载中...';
            this.disabled = true;

            fetch('/api/download-template/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken') || ''
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态码: ${response.status}`);
                    }
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = 'template.xlsx';

                    document.body.appendChild(a);
                    a.click();

                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    this.innerHTML = originalHtml;
                    this.disabled = false;

                    alert('模板下载成功！');
                })
                .catch(error => {
                    console.error('下载失败:', error);
                    alert('下载失败: ' + error.message);

                    this.innerHTML = originalHtml;
                    this.disabled = false;
                });
        });

        document.getElementById('batchImportBtn').addEventListener('click', function (e) {
            e.preventDefault();
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.xlsx')) {
                alert('请选择Excel文件 (.xlsx)');
                this.value = '';
                return;
            }

            const batchBtn = document.getElementById('batchImportBtn');
            const originalHtml = batchBtn.innerHTML;
            batchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 读取中...';
            batchBtn.style.pointerEvents = 'none';

            readExcelFile(file, batchBtn, originalHtml);
        });

        function readExcelFile(file, batchBtn, originalHtml) {
            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    console.log('Excel数据:', jsonData);

                    if (jsonData.length === 0) {
                        throw new Error('Excel文件中没有数据');
                    }

                    const stockCodes = [];
                    const columnNames = Object.keys(jsonData[0] || {});
                    console.log('列名:', columnNames);

                    let codeColumn = null;
                    for (let col of columnNames) {
                        if (col.includes('代码') || col.includes('stock') || col.includes('code') || col.toLowerCase().includes('code')) {
                            codeColumn = col;
                            break;
                        }
                    }

                    if (!codeColumn && columnNames.length > 0) {
                        codeColumn = columnNames[0];
                    }

                    if (!codeColumn) {
                        throw new Error('未找到数据列');
                    }

                    jsonData.forEach(row => {
                        if (row[codeColumn]) {
                            const code = String(row[codeColumn]).replace(/\s/g, '');
                            if (code.length >= 6) {
                                const sixDigitCode = code.substring(0, 6);
                                if (!isNaN(sixDigitCode) && sixDigitCode.length === 6) {
                                    stockCodes.push(sixDigitCode);
                                }
                            }
                        }
                    });

                    if (stockCodes.length === 0) {
                        alert('未找到有效的6位数字股票代码，请检查文件格式');
                        return;
                    }

                    const uniqueCodes = [...new Set(stockCodes)];
                    document.getElementById('stockCode').value = uniqueCodes.join(';');

                    alert(`成功导入 ${uniqueCodes.length} 个股票代码`);

                } catch (error) {
                    console.error('读取Excel文件失败:', error);
                    alert('读取Excel文件失败: ' + error.message + '\n请确保文件格式正确，包含"上市公司代码"列');
                } finally {
                    batchBtn.innerHTML = originalHtml;
                    batchBtn.style.pointerEvents = 'auto';
                    document.getElementById('fileInput').value = '';
                }
            };

            reader.onerror = function () {
                alert('文件读取失败，请重试');
                batchBtn.innerHTML = originalHtml;
                batchBtn.style.pointerEvents = 'auto';
                document.getElementById('fileInput').value = '';
            };

            reader.readAsArrayBuffer(file);
        }

        function displayHtmlResponse(htmlContent) {
            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>服务器响应详情</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
                            .container { background: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
                            h1 { color: #d32f2f; }
                            pre { background: #f8f8f8; padding: 15px; border-left: 4px solid #d32f2f; overflow: auto; }
                            .info { background: #e3f2fd; padding: 10px; border-radius: 3px; margin-bottom: 15px; }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <h1>服务器返回了HTML响应</h1>
                            <div class="info">
                                <p>这通常意味着：</p>
                                <ul>
                                    <li>Django视图函数没有返回JsonResponse</li>
                                    <li>URL配置不正确</li>
                                    <li>服务器发生了未处理的异常</li>
                                    <li>认证或权限问题</li>
                                </ul>
                            </div>
                            <h2>响应内容：</h2>
                            <pre>${escapeHtml(htmlContent)}</pre>
                            <button onclick="window.close()">关闭窗口</button>
                        </div>
                    </body>
                    </html>
                `);
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function downloadCurrentChart() {
            if (stocksData.length === 0 || currentChartIndex >= stocksData.length) {
                alert('没有可下载的图表');
                return;
            }

            if (currentChart) {
                const link = document.createElement('a');
                const stockData = stocksData[currentChartIndex];

                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const dateString = `${year}${month}${day}`;

                link.download = `${stockData.stock_name}(${stockData.stock_code})_${dateString}.png`;
                link.href = currentChart.toBase64Image();
                link.click();
            }
        }

        function downloadCurrentData() {
            if (stocksData.length === 0 || currentChartIndex >= stocksData.length) {
                alert('没有可下载的数据');
                return;
            }

            const stockData = stocksData[currentChartIndex];

            const marketCapData = stockData.market_cap_data || [];
            const profitData = stockData.profit_data || [];

            const dataMap = {};

            marketCapData.forEach(item => {
                const date = new Date(item.data_date);
                date.setFullYear(date.getFullYear() - 1);
                const dateStr = date.toISOString().split('T')[0];

                if (!dataMap[dateStr]) {
                    dataMap[dateStr] = { 日期: dateStr };
                }
                dataMap[dateStr]['市值'] = item.market_capitalization;
            });

            profitData.forEach(item => {
                const date = new Date(item.data_date);
                date.setFullYear(date.getFullYear() - 1);
                const dateStr = date.toISOString().split('T')[0];

                if (!dataMap[dateStr]) {
                    dataMap[dateStr] = { 日期: dateStr };
                }
                dataMap[dateStr]['净利润'] = item.net_profit_parent_quarterly;
            });

            const dataArray = Object.values(dataMap);

            dataArray.sort((a, b) => new Date(a.日期) - new Date(b.日期));

            if (dataArray.length === 0) {
                alert('没有可导出的数据');
                return;
            }

            const wb = XLSX.utils.book_new();

            const ws = XLSX.utils.json_to_sheet(dataArray);

            XLSX.utils.book_append_sheet(wb, ws, '股票数据');

            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateString = `${year}${month}${day}`;

            XLSX.writeFile(wb, `${stockData.stock_name}(${stockData.stock_code})_${dateString}.xlsx`, {
                bookType: 'xlsx',
                type: 'binary',
                cellStyles: true
            });
        }

        document.getElementById('stockCode').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                document.getElementById('confirmBtn').click();
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            initializeKnowledgeResearch();
        });

        function initializeKnowledgeResearch() {
            // 如果当前是知识研究面板，立即渲染文章
            if (document.getElementById('knowledge-research-panel').classList.contains('active')) {
                renderArticles('knowledge-research', 'knowledge-research-articles');
                setupArticleSearch();
            }

            // 添加点击事件监听器
            document.querySelector('[data-panel="knowledge-research-panel"]').addEventListener('click', function() {
                setTimeout(() => {
                    renderArticles('knowledge-research', 'knowledge-research-articles');
                    setupArticleSearch();
                }, 100);
            });
        }

        // 修改 setupArticleSearch 函数，正确处理清空搜索框的情况
        function setupArticleSearch() {
            const searchInput = document.getElementById('articleSearch');
    
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    if (this.value.trim() === '') {
                        // 搜索框为空时，恢复到初始状态（只显示标题和日期）
                        renderArticles('knowledge-research', 'knowledge-research-articles');
                    } else {
                        // 有搜索内容时，显示完整信息（包括简介和关键词）
                        filterArticles(this.value);
                    }
                });
            }
        }

        // 修改 renderArticles 函数，只显示标题和日期（初始状态）
        function renderArticles(category, containerId) {
            const container = document.getElementById(containerId);
            const articles = articlesData[category];
    
            if (!articles || articles.length === 0) {
                container.innerHTML = '<p class="no-articles">暂无文章</p>';
                return;
            }
    
            // 对文章按照id降序排序，id号大的在上面，id号小的在下面
            const sortedArticles = [...articles].sort((a, b) => b.id - a.id);
    
            // 初始状态：只显示标题和日期
            const articlesHTML = sortedArticles.map(article => `
                <div class="article-item" data-article-id="${article.id}">
                    <div class="article-header">
                        <div>
                            <a href="${article.url}" class="article-title-link" target="_blank">
                                ${article.title}
                            </a>
                            <span class="article-meta">${article.date}</span>
                        </div>
                    </div>
                </div>
            `).join('');
    
            container.innerHTML = articlesHTML;
        }

        // 修改 filterArticles 函数，确保搜索结果也按id降序排列
        function filterArticles(searchTerm) {
                const articles = articlesData['knowledge-research'];
                const filteredArticles = articles.filter(article => 
                article.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (article.description && article.description.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (article.keywords && article.keywords.some(keyword => 
                    keyword.toLowerCase().includes(searchTerm.toLowerCase())
                ))
            );
    
            renderFilteredArticles(filteredArticles);
        }

        // 修改 renderFilteredArticles 函数，显示完整信息（搜索状态）
        function renderFilteredArticles(articles) {
            const container = document.getElementById('knowledge-research-articles');

            if (articles.length === 0) {
                container.innerHTML = '<p class="no-articles">没有找到相关文章</p>';
                return;
            }

            // 对文章按照id降序排序，id号大的在上面，id号小的在下面
            const sortedArticles = [...articles].sort((a, b) => b.id - a.id);

            // 搜索状态：显示完整信息（标题、日期、简介、关键词）
            const articlesHTML = sortedArticles.map(article => `
                <div class="article-item" data-article-id="${article.id}">
                    <div class="article-header">
                        <div>
                            <a href="${article.url}" class="article-title-link" target="_blank">
                                ${article.title}
                            </a>
                            <span class="article-meta">${article.date}</span>
                        </div>
                    </div>
                    ${article.description ? `<p class="article-description">${article.description}</p>` : ''}
                    ${article.keywords ? `
                    <div class="article-footer">
                        <span class="article-keywords">
                            ${article.keywords.map(keyword => `<span class="keyword-tag">${keyword}</span>`).join('')}
                        </span>
                    </div>
                    ` : ''}
                </div>
            `).join('');

            container.innerHTML = articlesHTML;
        }


        // 初始化知识研究面板
        function initializeKnowledgeResearch() {
            // 如果当前是知识研究面板，立即渲染文章
            if (document.getElementById('knowledge-research-panel').classList.contains('active')) {
                renderArticles('knowledge-research', 'knowledge-research-articles');
                setupArticleSearch();
            }
    
            // 添加点击事件监听器
            document.querySelector('[data-panel="knowledge-research-panel"]').addEventListener('click', function() {
                setTimeout(() => {
                    renderArticles('knowledge-research', 'knowledge-research-articles');
                    setupArticleSearch();
                }, 100);
            });
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            checkUrlParamsAndSwitchPanel();
            initializeKnowledgeResearch();
        });

    </script>
</body>
</html>